name: CI/CD

on:
  push:
    branches: master

jobs:
    unit-tests:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Setup Node
              uses: "./.github/templates/setup-node"
            - run: yarn test:ci
            - uses: actions/upload-artifact@v3
              if: failure()
              with:
                  name: unit-tests-image-diffs
                  path: |
                      src/**/__diff_output__/*
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Setup Node
              uses: "./.github/templates/setup-node"
            - run: yarn lint
    e2e-tests-run:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Setup Node
              uses: "./.github/templates/setup-node"
            - name: Run E2E tests
              uses: "./.github/templates/run-playwright"
              with:
                packagescript: "e2e"
            - uses: actions/upload-artifact@v3
              if: success()
              with:
                  name: built-app
                  path: build
    ct-tests-run:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Setup Node
              uses: "./.github/templates/setup-node"
            - name: Run CT tests
              uses: "./.github/templates/run-playwright"
              with:
                packagescript: "test-ct"
    deploy:
        runs-on: ubuntu-latest
        needs: ['e2e-tests-run', 'ct-tests-run', 'unit-tests', 'lint']
        steps:
            - uses: actions/checkout@v2
            - uses: actions/download-artifact@v3
              with:
                  name: built-app
                  path: build
            - name: Deploy ðŸš€
              uses: JamesIves/github-pages-deploy-action@v4.3.0
              with:
                  branch: gh-pages # The branch the action should deploy to.
                  folder: build # The folder the action should deploy.
