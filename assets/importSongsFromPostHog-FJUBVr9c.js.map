{"version":3,"file":"importSongsFromPostHog-FJUBVr9c.js","sources":["../../src/modules/Songs/utils/importSongsFromPostHogBase.ts","../../src/modules/Songs/utils/importSongsFromPostHog.ts"],"sourcesContent":["import { Song, SongPreview } from 'interfaces';\nimport convertTxtToSong from './convertTxtToSong';\nimport getSongId from './getSongId';\n\nconst API_URL = 'https://eu.posthog.com';\nconst PROJECT_ID = '281';\nconst AFTER_DATE = new Date(Date.now() - 1000 * 3600 * 24 * 28).toISOString();\n\nconst suffixes = ['(tv)', '(album version)', '(movie version)', '[duet]'];\n\nconst normalizeSong = (song: Song): Song => {\n  suffixes.forEach((suffix) => {\n    if (song.title.toLowerCase().endsWith(suffix)) {\n      song.title = song.title.slice(0, -suffix.length);\n    }\n  });\n  song.title = song.title.trim();\n\n  song.language = song.language.map((lang) => {\n    if (lang.toLowerCase().startsWith('espa')) {\n      return 'Spanish';\n    } else if (lang.toLowerCase().endsWith('(romanized)')) {\n      return lang.slice(0, -11).trim();\n    } else if (lang.toLowerCase().endsWith('(brazil)')) {\n      return 'Portuguese';\n    }\n    return lang;\n  });\n\n  song.lastUpdate = new Date().toISOString();\n\n  // @ts-ignore\n  song.id = undefined;\n  song.id = getSongId(song);\n\n  return song;\n};\n\ntype RequestFunc = (url: string) => Promise<any>;\n\nexport const importSongsFromPostHogBase = async (\n  mkRequest: RequestFunc,\n  currentSongs: SongPreview[],\n  fetchedSongIds: string[],\n  onSongAdded: (song: Song) => Promise<void>,\n  from?: string,\n) => {\n  const response = await mkRequest(\n    `${API_URL}/api/projects/${PROJECT_ID}/events?event=share-song&after=${from ?? AFTER_DATE}&limit=200`,\n  );\n\n  await Promise.all(\n    response.results.map(async (result: any) => {\n      try {\n        let song = convertTxtToSong(result.properties.song);\n        if (!song.id) {\n          console.log('Song has no ID', song);\n          return;\n        }\n        normalizeSong(song);\n\n        if (fetchedSongIds.includes(song.id)) {\n          console.log(`Song ${song.id} already fetched`);\n        } else if ((song.tracks[0]?.sections.length ?? 0) < 5) {\n          console.log(`Song ${song.id} seems to be broken, ${song.tracks[0]?.sections.length} sections found`);\n        } else if (currentSongs.find((currentSong) => currentSong.id === song.id)) {\n          console.log(`Song ${song.id} already exists`);\n        } else {\n          song.lastUpdate = new Date().toISOString();\n          await onSongAdded(song);\n          console.log(`Added song ${song.id}`);\n        }\n      } catch (e) {\n        console.warn(`Couldn't convert song ${result.properties.song}`);\n      }\n    }),\n  );\n};\n","import { Song } from 'interfaces';\nimport SongsService from 'modules/Songs/SongsService';\nimport storage from 'modules/utils/storage';\nimport { importSongsFromPostHogBase } from './importSongsFromPostHogBase';\n\nconst importSongsFromPostHog = async () => {\n  const posthogKey = storage.session.getItem('posthog_key') || prompt('Enter PostHog PAT');\n\n  if (!posthogKey) {\n    return;\n  }\n  storage.session.setItem('posthog_key', posthogKey);\n\n  const defaultFrom = new Date();\n  defaultFrom.setDate(defaultFrom.getDate() - 10);\n\n  let from = prompt('Enter from', storage.local.getItem('posthog_from') || defaultFrom.toISOString());\n  if (from === null) {\n    return;\n  }\n  from = new Date(from).toISOString();\n\n  storage.local.setItem('posthog_from', new Date().toISOString());\n  const makeRequest = async (url: string) => {\n    const response = await fetch(url, {\n      headers: {\n        Authorization: `Bearer ${posthogKey}`,\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`Request failed with status ${response.status}`);\n    }\n\n    return response.json();\n  };\n\n  await importSongsFromPostHogBase(\n    makeRequest,\n    await SongsService.getIndex(true),\n    [],\n    async (song: Song) => {\n      return SongsService.store(song);\n    },\n    from,\n  );\n};\n\nexport default importSongsFromPostHog;\n"],"names":["API_URL","PROJECT_ID","AFTER_DATE","Date","now","toISOString","suffixes","normalizeSong","song","forEach","suffix","title","toLowerCase","endsWith","slice","length","trim","language","map","lang","startsWith","lastUpdate","id","undefined","getSongId","importSongsFromPostHogBase","mkRequest","currentSongs","fetchedSongIds","onSongAdded","from","response","Promise","all","results","result","convertTxtToSong","properties","log","includes","console","tracks","sections","find","currentSong","warn","importSongsFromPostHog","posthogKey","storage","session","getItem","prompt","setItem","defaultFrom","setDate","getDate","local","url","fetch","headers","Authorization","ok","Error","status","json","SongsService","getIndex","store"],"mappings":"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"}